<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postest Bimbingan Perkawinan • HTML</title>
  <style>
    :root{
      --emerald-50:#ecfdf5;--emerald-100:#d1fae5;--emerald-200:#a7f3d0;--emerald-300:#6ee7b7;--emerald-400:#34d399;--emerald-500:#10b981;--emerald-600:#059669;--emerald-700:#047857;
      --slate-50:#f8fafc;--slate-100:#f1f5f9;--slate-200:#e2e8f0;--slate-300:#cbd5e1;--slate-400:#94a3b8;--slate-500:#64748b;--slate-600:#475569;--slate-700:#334155;--slate-800:#1f2937;--slate-900:#0f172a;
      --rose-50:#fff1f2;--rose-400:#fb7185;--rose-600:#e11d48;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(#ecfdf5, #fff)}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .navbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--slate-200)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 24px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand-logo{width:32px;height:32px;border-radius:8px;object-fit:cover;display:block}
    .brand-badge{width:32px;height:32px;border-radius:8px;background:var(--emerald-600)}
    .btn{padding:10px 16px;border-radius:16px;border:1px solid transparent;background:var(--emerald-600);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.04);transition:.2s}
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn.ghost{background:#fff;color:var(--emerald-700);border-color:var(--slate-200)}
    .btn.neutral{background:var(--slate-800)}
    .btn.danger{background:var(--rose-600)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .badge{display:inline-block;border:1px solid var(--slate-200);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600}
    .card{background:#fff;border:1px solid var(--slate-200);border-radius:20px;padding:20px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .muted{color:var(--slate-500)}
    .title{font-size:24px;font-weight:800;color:var(--slate-900)}
    .subtitle{font-size:13px;color:var(--slate-600)}
    .label{display:block;font-size:13px;color:var(--slate-700);margin-bottom:6px;font-weight:600}
    .input,.textarea{width:100%;border:1px solid var(--slate-300);border-radius:12px;padding:10px 12px;font:inherit}
    .textarea{min-height:72px;resize:vertical}
    .row{display:flex;align-items:center;gap:10px}
    .space{height:8px}
    .spacer{height:16px}

    .fade{animation:fade .5s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .bar{height:8px;border-radius:999px;background:var(--slate-200);overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--emerald-500)}

    .option{width:100%;text-align:left;border:1px solid var(--slate-200);background:#fff;padding:12px;border-radius:16px;transition:.15s}
    .option:hover{box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .option.correct{border-color:var(--emerald-400);background:var(--emerald-50)}
    .option.wrong{border-color:var(--rose-400);background:var(--rose-50)}
    .explain{margin-top:12px;border:1px solid #b6f4d7;background:#ebfff7;color:#065f46;padding:12px;border-radius:14px;font-size:14px}

    .toggle{display:inline-flex;align-items:center;width:44px;height:24px;border-radius:999px;background:var(--slate-300);position:relative}
    .toggle span{position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:999px;background:#fff;transition:.2s}
    .toggle.on{background:var(--emerald-500)}
    .toggle.on span{transform:translateX(20px)}

    footer{padding:16px;text-align:center;color:var(--slate-500);font-size:12px}

    /* Confetti */
    @keyframes confetti{0%{transform:translateY(-100vh) rotate(0)}100%{transform:translateY(100vh) rotate(720deg)}}
    .confetti{position:fixed;top:-10vh;width:8px;height:14px;opacity:.9;border-radius:2px;animation:confetti 2.2s ease-out forwards;pointer-events:none}

    /* Table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border:1px solid var(--slate-200);font-size:13px}
    th{background:var(--slate-100);text-align:left}

    /* Responsive */
    @media (max-width:720px){.nav-inner{padding:10px 14px}.title{font-size:20px}}
  </style>
</head>
<body>
  <div class="navbar">
    <div class="nav-inner">
      <div class="brand">
        <img id="brandLogo" class="brand-logo" alt="Logo" style="display:none"/>
        <div id="brandBadge" class="brand-badge"></div>
        <span id="brandTitle">Postest Bimbingan Perkawinan</span>
      </div>
      <div class="row" id="navActions"><!-- will be filled by JS --></div>
    </div>
  </div>

  <main class="container" id="app"></main>
  <footer>© <span id="y"></span> Postest Bimbingan Perkawinan</footer>

<script>
(function(){
  // ==========================
  // KONFIGURASI & UTILITAS
  // ==========================
  const APP_NAME = 'Postest Bimbingan Perkawinan';
  const LOCAL_KEY = 'postestQuestions';
  const SETTINGS_KEY = 'postestSettings';
  const ATTEMPTS_KEY = 'postestAttempts';
  const PARTICIPANT_KEY = 'postestParticipantName';
  const DEFAULT_ADMIN_PASS = 'admin123';
  const ADMIN_FLAG = 'postestIsAdmin'; // sessionStorage flag

  function uuid(){
    if (window.crypto?.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);return v.toString(16);
    });
  }

  const DEFAULT_QUESTIONS = [
    { id: uuid(), text: 'Apa tujuan utama dari pernikahan dalam perspektif keluarga sakinah?',
      options: [
        { id: uuid(), text: 'Mencari status sosial', isCorrect:false },
        { id: uuid(), text: 'Mencari kebahagiaan duniawi semata', isCorrect:false },
        { id: uuid(), text: 'Membangun ketenangan, cinta, dan kasih sayang (sakinah)', isCorrect:true },
        { id: uuid(), text: 'Menghindari pajak', isCorrect:false },
      ],
      explanation: 'Keluarga sakinah menekankan ketenangan (sakinah), cinta (mawaddah), dan kasih sayang (rahmah).'
    },
    { id: uuid(), text: 'Siapa yang bertugas menjadi wali nikah bagi mempelai perempuan?',
      options: [
        { id: uuid(), text: 'Penghulu', isCorrect:false },
        { id: uuid(), text: 'Wali nasab yang memenuhi syarat', isCorrect:true },
        { id: uuid(), text: 'Saksi', isCorrect:false },
        { id: uuid(), text: 'Tetangga', isCorrect:false },
      ],
      explanation: 'Wali nikah adalah wali nasab (atau wali hakim bila tidak ada/terhalang), sementara penghulu bertugas mencatat dan memimpin jalannya akad.'
    },
    { id: uuid(), text: 'Dalam prosesi akad nikah di KUA, siapa yang berjabat tangan saat ijab kabul?',
      options: [
        { id: uuid(), text: 'Penghulu dan mempelai perempuan', isCorrect:false },
        { id: uuid(), text: 'Wali mempelai perempuan dan mempelai laki-laki', isCorrect:true },
        { id: uuid(), text: 'Saksi dan mempelai laki-laki', isCorrect:false },
        { id: uuid(), text: 'Orang tua mempelai laki-laki dan penghulu', isCorrect:false },
      ],
      explanation: 'Yang berjabat tangan saat ijab kabul adalah wali mempelai perempuan dengan mempelai laki-laki.'
    },
  ];

  const DEFAULT_SETTINGS = {
    title: APP_NAME,
    shuffleQuestions: true,
    shuffleOptions: true,
    passScore: 70,
    timeLimitMinutes: 10, // 0 = tanpa batas
    adminPass: DEFAULT_ADMIN_PASS,
    heroSubtitle: 'Postest ringkas dengan animasi halus. Cocok untuk kelas bimbingan perkawinan (KUA).',
    logoUrl: '' // NEW: logo URL
  };

  function loadQuestions(){
    try{ const raw = localStorage.getItem(LOCAL_KEY); if(!raw) return DEFAULT_QUESTIONS; const parsed = JSON.parse(raw); return Array.isArray(parsed)&&parsed.length?parsed:DEFAULT_QUESTIONS; }catch{ return DEFAULT_QUESTIONS }
  }
  function saveQuestions(qs){ localStorage.setItem(LOCAL_KEY, JSON.stringify(qs)); }
  function loadSettings(){
    try{ const raw = localStorage.getItem(SETTINGS_KEY); if(!raw) return DEFAULT_SETTINGS; const parsed = JSON.parse(raw); return {...DEFAULT_SETTINGS, ...parsed}; }catch{ return DEFAULT_SETTINGS }
  }
  function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); applyBrand(s); }
  function loadAttempts(){ try{ return JSON.parse(localStorage.getItem(ATTEMPTS_KEY)||'[]') }catch{ return [] } }
  function saveAttempts(a){ localStorage.setItem(ATTEMPTS_KEY, JSON.stringify(a)) }
  function shuffle(a){ const b=[...a]; for(let i=b.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [b[i],b[j]]=[b[j],b[i]] } return b }

  function isAdmin(){ return sessionStorage.getItem(ADMIN_FLAG)==='1' }
  function setAdmin(v){ if(v) sessionStorage.setItem(ADMIN_FLAG,'1'); else sessionStorage.removeItem(ADMIN_FLAG); updateNav() }

  // Apply brand (logo/title on navbar)
  function applyBrand(settings){
    const img = document.getElementById('brandLogo');
    const badge = document.getElementById('brandBadge');
    const title = document.getElementById('brandTitle');
    title.textContent = settings.title || APP_NAME;
    if(settings.logoUrl){ img.src = settings.logoUrl; img.style.display='block'; badge.style.display='none'; }
    else { img.style.display='none'; badge.style.display='block'; }
  }

  // ---------- CSV helpers ----------
  function makeCSV(rows){
    // FIX: gunakan '\n' sebagai pemisah baris (bukan line-break literal) agar tidak memicu SyntaxError
    return rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  }
  function exportAttemptsToCSV(){
    const rows = [[ 'Timestamp','Nama','Skor','Benar','Total','Lulus','Durasi(detik)' ]];
    const data = loadAttempts();
    data.forEach(a=>rows.push([a.ts,a.name,a.score,a.correct,a.total,a.passed?'YA':'TIDAK',a.durationSec]));
    const csv = makeCSV(rows);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='rekap_postest.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // ---------- Pure helper untuk Admin ----------
  function removeOptionFromQuestion(question, optionId, min=2){
    const nextOpts = question.options.filter(o=>o.id!==optionId);
    if(nextOpts.length < min){
      return { nextQuestion: question, removed:false };
    }
    let hadCorrectRemoved = !nextOpts.some(o=>o.isCorrect);
    const normalized = nextOpts.map((o,i)=> ({...o, isCorrect: hadCorrectRemoved ? i===0 : o.isCorrect }));
    return { nextQuestion: { ...question, options: normalized }, removed:true };
  }

  // ==========================
  // NAV & ROUTER
  // ==========================
  const app = document.getElementById('app');
  document.getElementById('y').textContent = new Date().getFullYear();
  applyBrand(loadSettings());

  function updateNav(){
    const nav = document.getElementById('navActions');
    nav.innerHTML='';
    const btnQuiz = btn('Postest','ghost',()=>go('#/quiz'));
    const btnAdmin = btn('Admin','ghost',()=>go('#/admin'));
    nav.appendChild(btnQuiz);
    nav.appendChild(btnAdmin); // selalu tampil, akan diarahkan ke login jika belum admin
    if(isAdmin()){
      nav.appendChild(btn('Logout','danger',()=>{ setAdmin(false); go('#/quiz') }))
    }
  }
  function btn(text, variant, onClick){
    const b=document.createElement('button'); b.className=`btn ${variant||''}`; b.textContent=text; b.onclick=onClick; return b;
  }

  function go(hash){ if(location.hash!==hash) location.hash=hash; else route(); }
  window.addEventListener('hashchange', route);

  function route(){
    const h = location.hash || '#/quiz';
    if(h.startsWith('#/admin')){
      if(!isAdmin()) return renderLogin();
      return renderAdmin();
    }
    return renderQuiz();
  }

  updateNav();

  // ==========================
  // QUIZ / POSTEST
  // ==========================
  function renderQuiz(){
    const settings = loadSettings();
    const rawQs = loadQuestions();
    const questions = (settings.shuffleQuestions?shuffle(rawQs):rawQs).map(q=>({...q, options: settings.shuffleOptions?shuffle(q.options):q.options}));
    const total = questions.length;
    let idx = 0; const answers = {}; let showResult=false; let timeLeft = settings.timeLimitMinutes*60; let timer=null; let celebrate=false; const startTime = Date.now();
    let participantName = (localStorage.getItem(PARTICIPANT_KEY)||'').trim();

    if(settings.timeLimitMinutes){
      timer = setInterval(()=>{
        timeLeft--; if(timeLeft<=0){ clearInterval(timer); timeLeft=0; showResult=true; update() }
        tickTime();
      },1000);
    }

    function pick(optionId){ answers[questions[idx].id]=optionId; update() }
    function next(){ if(idx<total-1){ idx++; update() } else { showResult=true; update() } }
    function prev(){ if(idx>0){ idx--; update() } }

    function calc(){
      let correct=0; for(const q of questions){ const a=answers[q.id]; if(!a) continue; const o=q.options.find(x=>x.id===a); if(o?.isCorrect) correct++; }
      const score = Math.round((correct/Math.max(1,total))*100); return {correct, score, passed: score>=settings.passScore};
    }

    function tickTime(){ const el=document.getElementById('timeBadge'); if(!el) return; if(settings.timeLimitMinutes){ const m=Math.floor(timeLeft/60), s=String(timeLeft%60).padStart(2,'0'); el.textContent = `Waktu: ${m}:${s}` } else el.textContent='Tanpa Batas Waktu' }

    function mkConfetti(){
      const colors=['#22c55e','#16a34a','#10b981','#84cc16','#059669'];
      for(let i=0;i<60;i++){
        const d=document.createElement('div'); d.className='confetti'; d.style.left=(Math.random()*100)+'vw'; d.style.background=colors[i%colors.length]; d.style.animationDuration=(1.8+Math.random()*1.2)+'s'; d.style.animationDelay=(Math.random()*0.35)+'s'; document.body.appendChild(d); setTimeout(()=>d.remove(),2400);
      }
    }

    function saveAttempt(){
      const {correct, score, passed} = calc();
      const durationSec = Math.max(0, Math.round((Date.now()-startTime)/1000));
      const attempt = {
        ts: new Date().toISOString(),
        name: participantName || '-',
        score, correct, total, passed, durationSec
      };
      const arr = loadAttempts();
      arr.push(attempt); saveAttempts(arr);
    }

    function header(){
      return `
      <div class="row" style="justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="title">${settings.title}</div>
          <div class="subtitle">${settings.heroSubtitle||''}</div>
          <div class="space"></div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <label class="label" style="margin:0">Nama Peserta</label>
            <input class="input" id="participantName" placeholder="Tulis nama" value="${escapeHTML(participantName)}" style="max-width:260px"/>
          </div>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="badge">${total} Soal</span>
          <span class="badge">Lulus ≥ ${settings.passScore}%</span>
          <span class="badge" id="timeBadge"></span>
        </div>
      </div>`;
    }

    function quizCard(){
      const q=questions[idx]; const picked=answers[q.id];
      return `
      <div class="card fade">
        <div class="row" style="justify-content:space-between;margin-bottom:10px">
          <div class="subtitle">Soal ${idx+1} / ${total}</div>
          <div class="bar" style="width:180px"><span style="width:${((idx+1)/total)*100}%"></span></div>
        </div>
        <div style="font-weight:700;color:var(--slate-900);margin:8px 0 12px">${q.text}</div>
        ${q.options.map(op=>{
          const isPicked = picked===op.id; const cls = isPicked?(op.isCorrect?'option correct':'option wrong'):'option';
          return `<button class="${cls}" data-role="option" data-id="${op.id}">
            <div class="row" style="justify-content:space-between">
              <span>${op.text}</span>
              ${isPicked?`<span class="subtitle" style="font-weight:700;color:${op.isCorrect?'#047857':'#e11d48'}">${op.isCorrect?'Benar':'Kurang Tepat'}</span>`:''}
            </div>
          </button>`
        }).join('')}
        ${picked?`<div class="explain">${q.explanation||''}</div>`:''}
        <div class="spacer"></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn ghost" id="btnPrev" ${idx===0?'disabled':''}>Kembali</button>
          <div class="row" style="gap:8px">
            <button class="btn" id="btnNext">${idx===total-1?'Selesai':'Berikutnya'}</button>
          </div>
        </div>
      </div>`
    }

    function resultCard(){
      const {correct, score, passed} = calc();
      return `
      <div class="card fade">
        <div style="text-align:center;margin-bottom:10px">
          <div class="bar" style="max-width:520px;margin:0 auto 10px"><span style="width:${score}%"></span></div>
          <div class="title">Skor Anda: ${score}%</div>
          <div class="subtitle">Benar ${correct} dari ${total} soal.</div>
          <div style="margin-top:6px;font-weight:800;color:${passed?'#059669':'#e11d48'}">${passed?'Selamat! Anda LULUS.':'Belum lulus. Silakan ulangi kembali.'}</div>
        </div>
        <div class="row" style="justify-content:center;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnReload">Ulangi Postest</button>
          <button class="btn ghost" id="btnCSV">Unduh Rekap (CSV)</button>
        </div>
      </div>`
    }

    function update(){
      app.innerHTML = `
        ${header()}
        <div class="spacer"></div>
        ${!showResult?quizCard():resultCard()}
      `;
      tickTime();

      const nameInput = app.querySelector('#participantName');
      if(nameInput){ nameInput.oninput = (e)=>{ participantName = e.target.value; localStorage.setItem(PARTICIPANT_KEY, participantName) } }
      const optBtns = app.querySelectorAll('[data-role="option"]');
      optBtns.forEach(b=>b.onclick = ()=>pick(b.getAttribute('data-id')));
      const btnPrev=app.querySelector('#btnPrev'); if(btnPrev) btnPrev.onclick=prev;
      const btnNext=app.querySelector('#btnNext'); if(btnNext) btnNext.onclick=()=>{ if(idx===total-1){ if(!showResult){ saveAttempt(); } } next(); };
      const btnReload=app.querySelector('#btnReload'); if(btnReload) btnReload.onclick=()=>renderQuiz();
      const btnCSV=app.querySelector('#btnCSV'); if(btnCSV) btnCSV.onclick=exportAttemptsToCSV;

      if(showResult){ const {passed}=calc(); if(passed && !celebrate){ celebrate=true; mkConfetti(); setTimeout(()=>celebrate=false,2600) } }
    }

    update();
  }

  // ==========================
  // LOGIN ADMIN (TERPISAH) & ADMIN PANEL
  // ==========================
  function renderLogin(){
    const settings = loadSettings();
    app.innerHTML = `
      <div class="card" style="max-width:520px;margin:0 auto">
        <div class="title" style="margin-bottom:6px">Masuk Admin</div>
        <div class="subtitle" style="margin-bottom:12px">Masukkan kata sandi admin untuk mengelola soal dan pengaturan.</div>
        <label class="label">Kata Sandi</label>
        <input class="input" type="password" id="admPass" placeholder="••••••" />
        <div class="spacer"></div>
        <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
          <button class="btn" id="btnGo">Masuk</button>
          <button class="btn ghost" id="btnBack">Kembali ke Postest</button>
        </div>
      </div>`;
    document.getElementById('btnGo').onclick=()=>{
      const v=document.getElementById('admPass').value; if(v===(settings.adminPass||DEFAULT_ADMIN_PASS)){ setAdmin(true); go('#/admin') } else { alert('Kata sandi salah.') }
    };
    document.getElementById('btnBack').onclick=()=>go('#/quiz');
  }

  function renderAdmin(){
    const settings = loadSettings();
    const questions = loadQuestions();

    let filter='';

    function panel(){
      function save(){ saveSettings(_settings); saveQuestions(_questions) }
      let _settings = {...settings};
      let _questions = [...questions];

      function ui(){
        app.innerHTML = `
          <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
              <div class="title">Admin • ${_settings.title}</div>
              <div class="subtitle">Kelola pengaturan, bank soal, dan rekap nilai.</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" id="btnView">Lihat Postest</button>
              <button class="btn danger" id="btnLogout">Logout</button>
              <button class="btn" id="btnAdd">+ Tambah Soal</button>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="card">
            <div style="font-weight:800;margin-bottom:10px">Pengaturan</div>
            <div class="row" style="gap:12px;flex-wrap:wrap">
              <div style="flex:1 1 260px">
                <label class="label">Judul Aplikasi</label>
                <input class="input" id="setTitle" value="${escapeHTML(_settings.title)}"/>
              </div>
              <div style="flex:1 1 260px">
                <label class="label">Subjudul (Hero)</label>
                <input class="input" id="setSub" value="${escapeHTML(_settings.heroSubtitle)}"/>
              </div>
              <div style="flex:1 1 160px">
                <label class="label">Lulus Minimal (%)</label>
                <input class="input" id="setPassScore" type="number" min="0" max="100" value="${_settings.passScore}"/>
              </div>
              <div style="flex:1 1 160px">
                <label class="label">Batas Waktu (menit)</label>
                <input class="input" id="setTime" type="number" min="0" value="${_settings.timeLimitMinutes}"/>
              </div>
              <div style="flex:1 1 200px">
                <label class="label">Acak Urutan Soal</label>
                <button class="toggle ${_settings.shuffleQuestions?'on':''}" id="tglQs"><span></span></button>
              </div>
              <div style="flex:1 1 200px">
                <label class="label">Acak Urutan Opsi</label>
                <button class="toggle ${_settings.shuffleOptions?'on':''}" id="tglOp"><span></span></button>
              </div>
              <div style="flex:1 1 260px">
                <label class="label">Kata Sandi Admin</label>
                <input class="input" id="setAdminPass" value="${escapeHTML(_settings.adminPass)}"/>
              </div>
              <div style="flex:1 1 320px">
                <label class="label">Logo URL (opsional)</label>
                <input class="input" id="setLogoUrl" placeholder="https://.../logo.png" value="${escapeHTML(_settings.logoUrl||'')}"/>
                <div class="subtitle">Logo akan tampil di kiri judul pada navbar.</div>
              </div>
            </div>
            <div class="spacer"></div>
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <button class="btn" id="btnExport">Export JSON</button>
              <label class="btn ghost" style="display:inline-block;cursor:pointer">
                <input type="file" id="fileImport" accept="application/json" style="display:none"/>
                Import JSON
              </label>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="card">
            <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div style="font-weight:800">Bank Soal (<span id="qCount">${_questions.length}</span>)</div>
              <input class="input" id="filter" placeholder="Cari soal..." style="max-width:280px"/>
            </div>
            <div class="spacer"></div>
            <div id="qList" class="column" style="display:grid;gap:12px"></div>
            <div id="emptyMsg" class="subtitle" style="display:none">Tidak ada soal yang cocok dengan pencarian.</div>
          </div>

          <div class="spacer"></div>

          <div class="card">
            <div style="font-weight:800;margin-bottom:10px">Rekap Nilai</div>
            <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
              <button class="btn ghost" id="btnCSV2">Unduh Rekap (CSV)</button>
              <button class="btn danger" id="btnClearRekap">Bersihkan Rekap</button>
            </div>
            <div style="max-height:320px;overflow:auto">
              <table id="rekapTable">
                <thead><tr><th>#</th><th>Waktu</th><th>Nama</th><th>Skor</th><th>Benar</th><th>Total</th><th>Lulus</th><th>Durasi (dtk)</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <footer class="subtitle">Perubahan disimpan otomatis ke browser (localStorage).</footer>
        `;

        // Settings listeners
        document.getElementById('setTitle').oninput = e=>{ _settings.title=e.target.value; save(); };
        document.getElementById('setSub').oninput = e=>{ _settings.heroSubtitle=e.target.value; save(); };
        document.getElementById('setPassScore').oninput = e=>{ _settings.passScore=Number(e.target.value||0); save(); };
        document.getElementById('setTime').oninput = e=>{ _settings.timeLimitMinutes=Number(e.target.value||0); save(); };
        document.getElementById('setAdminPass').oninput = e=>{ _settings.adminPass=e.target.value; save(); };
        document.getElementById('setLogoUrl').oninput = e=>{ _settings.logoUrl=e.target.value; save(); };
        document.getElementById('tglQs').onclick = ()=>{ _settings.shuffleQuestions=!_settings.shuffleQuestions; save(); ui() };
        document.getElementById('tglOp').onclick = ()=>{ _settings.shuffleOptions=!_settings.shuffleOptions; save(); ui() };

        document.getElementById('btnView').onclick = ()=>go('#/quiz');
        document.getElementById('btnLogout').onclick = ()=>{ setAdmin(false); go('#/quiz') };
        document.getElementById('btnAdd').onclick = ()=>{ addQuestion(); drawList() };
        document.getElementById('btnExport').onclick = exportJSON;
        document.getElementById('fileImport').onchange = importJSON;
        document.getElementById('filter').oninput = e=>{ filter=e.target.value.toLowerCase(); drawList() };
        document.getElementById('btnCSV2').onclick = exportAttemptsToCSV;
        document.getElementById('btnClearRekap').onclick = ()=>{ if(confirm('Hapus semua rekap nilai?')){ saveAttempts([]); drawRekap() } };

        drawList();
        drawRekap();
      }

      function addQuestion(){
        const q={ id:uuid(), text:'[Tulis pertanyaan]', options:[
          {id:uuid(), text:'Pilihan A', isCorrect:true},
          {id:uuid(), text:'Pilihan B', isCorrect:false},
          {id:uuid(), text:'Pilihan C', isCorrect:false},
          {id:uuid(), text:'Pilihan D', isCorrect:false},
        ], explanation:'[Penjelasan singkat setelah peserta memilih]'};
        _questions=[q,..._questions]; save();
      }
      function delQuestion(id){ if(!confirm('Hapus soal ini?')) return; _questions=_questions.filter(q=>q.id!==id); save(); drawList() }
      function updateQuestion(id,patch){ _questions=_questions.map(q=>q.id===id?{...q,...patch}:q); save() }
      function updateOption(qid, oid, patch){ _questions=_questions.map(q=> q.id!==qid? q : {...q, options:q.options.map(o=>o.id===oid?{...o,...patch}:o)}); save() }
      function addOption(qid){ _questions=_questions.map(q=> q.id!==qid? q : {...q, options:[...q.options,{id:uuid(),text:'Pilihan baru',isCorrect:false}]}); save(); drawList() }
      function removeOption(qid, oid){ _questions=_questions.map(q=>{ if(q.id!==qid) return q; const {nextQuestion,removed}=removeOptionFromQuestion(q,oid,2); if(!removed){ alert('Minimal 2 opsi per soal.'); return q } return nextQuestion }); save(); drawList() }
      function markCorrect(qid, oid){ _questions=_questions.map(q=> q.id!==qid? q : {...q, options:q.options.map(o=>({...o,isCorrect:o.id===oid}))}); save(); drawList() }

      function exportJSON(){
        const blob=new Blob([JSON.stringify({settings:_settings,questions:_questions},null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='postest_export.json'; a.click(); URL.revokeObjectURL(url);
      }
      function importJSON(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(data.settings){ _settings={...DEFAULT_SETTINGS,...data.settings}; saveSettings(_settings) } if(Array.isArray(data.questions)){ _questions=data.questions; saveQuestions(_questions) } alert('Import berhasil.'); ui() }catch{ alert('File tidak valid.') } }; r.readAsText(f); e.target.value=''; }

      function drawList(){
        const list=document.getElementById('qList'); const empty=document.getElementById('emptyMsg');
        const items = _questions.filter(q=>!filter || q.text.toLowerCase().includes(filter));
        empty.style.display = items.length? 'none':'block';
        document.getElementById('qCount').textContent=_questions.length;
        list.innerHTML = items.map((q,i)=>{
          return `
          <div class="card" data-qid="${q.id}">
            <div class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:6px">
              <div class="subtitle">Soal #${i+1}</div>
              <button class="btn ghost" data-action="del">Hapus</button>
            </div>
            <label class="label">Pertanyaan</label>
            <textarea class="textarea" data-action="qtext">${escapeHTML(q.text)}</textarea>
            <div class="spacer"></div>
            <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
              ${q.options.map(o=>`
                <div class="card" style="border-color:${o.isCorrect?'#34d399':'#e2e8f0'}" data-oid="${o.id}">
                  <div class="row" style="justify-content:space-between;margin-bottom:6px">
                    <div class="subtitle">Opsi</div>
                    <div class="row" style="gap:6px">
                      <button class="btn ghost" data-action="setTrue">Jadikan Benar</button>
                      <button class="btn danger" data-action="delOpt">Hapus Opsi</button>
                    </div>
                  </div>
                  <input class="input" data-action="otext" value="${escapeHTML(o.text)}" />
                </div>`).join('')}
            </div>
            <div class="spacer"></div>
            <button class="btn ghost" data-action="addOpt">+ Tambah Opsi</button>
            <div class="spacer"></div>
            <label class="label">Penjelasan</label>
            <textarea class="textarea" data-action="qexp">${escapeHTML(q.explanation||'')}</textarea>
          </div>`
        }).join('');

        // wire events per item
        list.querySelectorAll('[data-qid]').forEach(box=>{
          const qid=box.getAttribute('data-qid');
          box.querySelector('[data-action="del"]').onclick=()=>delQuestion(qid);
          box.querySelector('[data-action="qtext"]').oninput=e=>updateQuestion(qid,{text:e.target.value});
          box.querySelector('[data-action="qexp"]').oninput=e=>updateQuestion(qid,{explanation:e.target.value});
          const addOptBtn = box.querySelector('[data-action="addOpt"]'); if(addOptBtn) addOptBtn.onclick=()=>addOption(qid);
          box.querySelectorAll('[data-oid]').forEach(opBox=>{
            const oid=opBox.getAttribute('data-oid');
            opBox.querySelector('[data-action="setTrue"]').onclick=()=>markCorrect(qid,oid);
            opBox.querySelector('[data-action="delOpt"]').onclick=()=>removeOption(qid,oid);
            opBox.querySelector('[data-action="otext"]').oninput=e=>updateOption(qid,oid,{text:e.target.value});
          })
        })
      }

      function drawRekap(){
        const tbody = document.querySelector('#rekapTable tbody');
        const data = loadAttempts();
        tbody.innerHTML = data.map((a,i)=>`<tr><td>${i+1}</td><td>${a.ts}</td><td>${escapeHTML(a.name)}</td><td>${a.score}</td><td>${a.correct}</td><td>${a.total}</td><td>${a.passed?'YA':'TIDAK'}</td><td>${a.durationSec}</td></tr>`).join('');
      }

      save();
      ui();
    }

    panel();
  }

  // Helpers
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

  // ==========================
  // DEV SELF-TESTS
  // ==========================
  function runSelfTests(){
    const results = [];
    function ok(name){ results.push({name, pass:true}); }
    function fail(name,msg){ results.push({name, pass:false, msg}); }

    // 1) CSV newline harus pakai "\\n" (bukan literal line-break)
    try{
      const csv = makeCSV([["A","B"],["1","2"]]);
      if(csv.includes("\n") && csv.split("\n").length===2) ok('CSV uses \\n separators');
      else fail('CSV uses \\n separators','CSV tidak berformat benar');
    }catch(e){ fail('CSV build', e.message); }

    // 1b) CSV harus menggandakan tanda kutip ganda
    try{
      const c = makeCSV([["He said \"Hi\""]]);
      if(/"He said ""Hi"""/.test(c)) ok('CSV quotes escaped');
      else fail('CSV quotes escaped','Double quotes tidak digandakan');
    }catch(e){ fail('CSV quotes escaped', e.message); }

    // 1c) CSV kolom dipisah koma dengan benar (tanpa koma dalam data)
    try{
      const c2 = makeCSV([["X","Y"],["3","4"]]).split("\n");
      if(c2.every(r=>r.split(',').length===2)) ok('CSV comma separation'); else fail('CSV comma separation','Jumlah kolom tidak tepat');
    }catch(e){ fail('CSV comma separation', e.message); }

    // 2) removeOptionFromQuestion menjaga minimal 2 opsi
    try{
      const q={id:'q', text:'t', options:[{id:'a',text:'A',isCorrect:true},{id:'b',text:'B',isCorrect:false}]};
      const r=removeOptionFromQuestion(q,'a',2);
      if(!r.removed && r.nextQuestion.options.length===2) ok('Min 2 opsi terjaga'); else fail('Min 2 opsi','Seharusnya tidak boleh kurang dari 2');
    }catch(e){ fail('removeOptionFromQuestion', e.message); }

    // 2b) Jika opsi benar dihapus dan opsi masih >=2, tetapkan yang pertama jadi benar
    try{
      const q2={id:'q2', text:'t', options:[{id:'a',text:'A',isCorrect:true},{id:'b',text:'B',isCorrect:false},{id:'c',text:'C',isCorrect:false}]};
      const r2=removeOptionFromQuestion(q2,'a',2);
      if(r2.removed && r2.nextQuestion.options[0].isCorrect===true) ok('Reassign correct after deletion');
      else fail('Reassign correct after deletion','Tidak menetapkan jawaban benar baru');
    }catch(e){ fail('Reassign correct after deletion', e.message); }

    // 2c) Menghapus opsi salah tidak mengubah jawaban benar yang ada
    try{
      const q3={id:'q3', text:'t', options:[{id:'a',text:'A',isCorrect:true},{id:'b',text:'B',isCorrect:false},{id:'c',text:'C',isCorrect:false}]};
      const r3=removeOptionFromQuestion(q3,'b',2);
      const stillCorrect = r3.nextQuestion.options.find(o=>o.isCorrect)?.text==='A';
      if(r3.removed && stillCorrect) ok('Deleting wrong option keeps correct'); else fail('Deleting wrong option keeps correct','Jawaban benar berubah tanpa alasan');
    }catch(e){ fail('Deleting wrong option keeps correct', e.message); }

    // 3) escapeHTML aman
    try{
      const s=escapeHTML('<script>"\'&');
      if(/&lt;script&gt;/.test(s) && /&quot;/.test(s) && /&#39;/.test(s) && /&amp;/.test(s)) ok('escapeHTML bekerja'); else fail('escapeHTML','Karakter tidak di-escape');
    }catch(e){ fail('escapeHTML', e.message); }

    // 4) Navbar: Admin harus SELALU tampil (non-admin pun lihat), tapi route guard tetap minta login
    try{
      setAdmin(false); updateNav();
      const navText = document.getElementById('navActions').textContent;
      if(/Admin/.test(navText)) ok('Admin visible for all'); else fail('Admin visible','Tombol Admin tidak tampil untuk non-admin');
      // Guard ke halaman admin akan tampilkan form login
      location.hash = '#/admin'; route();
      const hasLogin = !!document.getElementById('admPass');
      if(hasLogin) ok('Route guard to login'); else fail('Route guard','Admin terbuka tanpa login');
      // Pemulihan
      location.hash = '#/quiz'; route();
    }catch(e){ fail('Nav/route guard', e.message); }

    // 5) Setelah login, halaman admin benar-benar tampil dan tombol Logout ada
    try{
      setAdmin(true); updateNav(); location.hash = '#/admin'; route();
      const hasQList = !!document.getElementById('qList');
      const navText2 = document.getElementById('navActions').textContent;
      if(hasQList && /Logout/.test(navText2)) ok('Admin page & Logout visible after login');
      else fail('Admin page after login','Elemen admin atau tombol Logout tidak ditemukan');
      // cleanup
      setAdmin(false); location.hash = '#/quiz'; route();
    }catch(e){ fail('Admin after login', e.message); }

    console.group('%cSelf-tests','font-weight:bold');
    results.forEach((r,i)=>{ if(r.pass) console.log(`✅ [${i+1}]`, r.name); else console.error(`❌ [${i+1}]`, r.name,'→',r.msg||''); });
    console.groupEnd();
  }

  // Start
  updateNav();
  runSelfTests();
  route();
})();
</script>
</body>
</html>
